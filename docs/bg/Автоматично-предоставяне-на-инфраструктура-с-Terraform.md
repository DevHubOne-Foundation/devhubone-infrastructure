# Автоматично предоставяне на инфраструктура с Terraform

Този документ описва как инфраструктурата на DevHubOne се предоставя автоматично
като код, използвайки Terraform.

## Какво е Terraform и как го използваме?

Terraform е инструмент с отворен код за инфраструктура като код (IaC), който позволява
на потребителите да дефинират и предоставят инфраструктура, използвайки декларативни
конфигурационни файлове.

В DevHubOne Terraform се използва за управление както на инфраструктурата във Vercel,
така и на тази в AWS, като автоматизира внедряването и скалирането на приложенията
на организацията, като основния уебсайт и цялата DevHubOne Guild. Освен това се
използва за конфигуриране и поддържане на GitHub хранилищата, основния Discord
сървър и други.

Това ни позволява да оптимизираме нашите операции с надеждни, повтаряеми и добре
документирани процеси.

## Terraform автоматизация чрез GitHub Workflows

За автоматизация на работните процеси с Terraform сме създали две основни GitHub
Actions автоматизации: **Terraform Plan** и **Terraform Apply**. Тези автоматизации
гарантират, че всички промени в инфраструктурата са проверени и приложени чрез
Terraform Cloud.

### Terraform Plan автоматизация

Файлът `terraform-plan.yaml` се стартира автоматично, когато е създаден или обновен
pull request, който засяга директорията `terraform/`. Този workflow изпълнява следните
стъпки:

1. **Извличане на репозитория**
   Workflow извлича последния код от репозитория.

2. **Настройка на Terraform CLI**
   Настройва се Terraform CLI и конфигурацията се качва в Terraform Cloud в работната
   среда на проекта.

3. **Създаване на план**
   Създава се спекулативен план в Terraform Cloud, който проверява какви ресурси
   ще бъдат добавени, променени или унищожени, без да прави реални промени.

4. **Получаване на изхода от плана**
   Изходът на плана (брой ресурси за добавяне, модификация или унищожаване) се
   получава от Terraform Cloud.

5. **Актуализиране на PR с обобщение на плана**
   Workflow проверява за предишни коментари в pull request-а и ги актуализира или
   заменя с най-новото обобщение на плана от Terraform. Това обобщение включва
   хипервръзка към пълния план в Terraform Cloud и предоставя ясни детайли за предложените
   промени в инфраструктурата.

### Terraform Apply автоматизация

Файлът `terraform-apply.yaml` се стартира, когато промените са обединени в основния
клон (branch) на хранилището. Тази автоматизация е отговорна за прилагането на
конфигурационните промени в реалната инфраструктура. Изпълнява следните стъпки:

1. **Извличане на репозитория**
   Както и в плана, тук се взема последната версия на хранилището.

2. **Настройка на Terraform CLI**
   Конфигурацията се качва в Terraform Cloud в съответната работна среда.

3. **Създаване на Apply Run**
   Инициира се процес по прилагане на новата конфигурация в инфраструктурата.
   Това ще изпълни промените, планирани по-рано, като добавяне, модифициране или
   изтриване на ресурси.

4. **Прилагане на промените**
   Ако процесът е успешно валидиран от Terraform Cloud, промените се прилагат.

И двата workflows гарантират, че имаме надеждна система за промяна на инфраструктурата.
`Terraform Plan` автоматизацията подсигурява, че промените се преглеждат преди
обединяване в main, а `Terraform Apply` автоматизацията гарантира, че промените
се прилагат след одобрение и обединяване в основния клон (branch).

## Управление на GitHub хранилища с Terraform

В DevHubOne Terraform се използва за управление на различни аспекти на нашите GitHub
кодови хранилища, като гарантира последователност и автоматизация в настройките
на хранилищата. Основните елементи, които се управляват, включват:

- **Конфигурация на хранилищата**
  Настройки на хранилище като видимост, функции на проекта (issues, проекти) и
  проверки и ограничения при внедряване на промени в кода (merge).

- **Защита на клонове**
  Terraform налага правила за защита на критични клонове (branches), изисквайки
  прегледи и статус проверки за всички промени.

- **Етикети за задачи**
  Създаването и управлението на предварително дефинирани етикети също се извършват
  чрез Terraform, като се осигурява правилно категоризиране и проследяване в GitHub
  Issues и Pull Requests.

- **Крайни цели**
  Terraform дефинира също така и цели за проекта, които служат за проследяване
  на крайни срокове в различните хранилища.

Този подход ни позволява да поддържаме последователна настройка във всички хранилища,
включително `devhubone-guild` и `devhubone-infrastructure`.
